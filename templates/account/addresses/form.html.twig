{% extends 'base.html.twig' %}

{% block title %}{{ isEdit ? 'Modifier' : 'Nouvelle' }} adresse - Vite & Gourmand{% endblock %}

{% block body %}

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            {# En-tête #}
            <div class="mb-4">
                <a href="{{ path('app_account_addresses') }}" class="text-decoration-none text-muted mb-2 d-inline-block">
                    <i data-feather="arrow-left" width="16"></i> Retour à mes adresses
                </a>
                <h1 class="h2 fw-bold mb-1" style="color: var(--primary);">
                    <i data-feather="{% if isEdit %}edit-2{% else %}plus{% endif %}" width="32" class="me-2"></i>
                    {{ isEdit ? 'Modifier l\'adresse' : 'Nouvelle adresse' }}
                </h1>
                <p class="text-muted mb-0">
                    {% if isEdit %}
                        Modifiez les informations de votre adresse
                    {% else %}
                        Ajoutez une nouvelle adresse de livraison
                    {% endif %}
                </p>
            </div>

            {# Formulaire #}
            <div class="account-card">
                <div class="card-body">
                    {{ form_start(form) }}

                    <div class="row g-3">
                        {# Label (optionnel) #}
                        <div class="col-12">
                            <div class="mb-3">
                                {{ form_label(form.label, null, {'label_attr': {'class': 'form-label fw-bold'}}) }}
                                {{ form_widget(form.label) }}
                                {{ form_help(form.label) }}
                                {{ form_errors(form.label) }}
                            </div>
                        </div>

                        {# Adresse #}
                        <div class="col-12">
                            <div class="mb-3">
                                {{ form_label(form.street, null, {'label_attr': {'class': 'form-label fw-bold'}}) }}
                                <span class="text-danger">*</span>
                                {{ form_widget(form.street) }}
                                {{ form_errors(form.street) }}
                            </div>
                        </div>

                        {# Code postal et Ville #}
                        <div class="col-md-4">
                            <div class="mb-3">
                                {{ form_label(form.postalCode, null, {'label_attr': {'class': 'form-label fw-bold'}}) }}
                                <span class="text-danger">*</span>
                                {{ form_widget(form.postalCode) }}
                                {{ form_errors(form.postalCode) }}
                            </div>
                        </div>

                        <div class="col-md-8">
                            <div class="mb-3">
                                {{ form_label(form.city, null, {'label_attr': {'class': 'form-label fw-bold'}}) }}
                                <span class="text-danger">*</span>
                                {{ form_widget(form.city) }}
                                {{ form_errors(form.city) }}
                            </div>
                        </div>

                        {# Téléphone #}
                        <div class="col-12">
                            <div class="mb-3">
                                {{ form_label(form.phone, null, {'label_attr': {'class': 'form-label fw-bold'}}) }}
                                <span class="text-danger">*</span>
                                {{ form_widget(form.phone) }}
                                {{ form_help(form.phone) }}
                                {{ form_errors(form.phone) }}
                            </div>
                        </div>

                        {# Adresse par défaut #}
                        <div class="col-12">
                            <div class="form-check mb-3">
                                {{ form_widget(form.isDefault, {'attr': {'class': 'form-check-input'}}) }}
                                {{ form_label(form.isDefault, null, {'label_attr': {'class': 'form-check-label'}}) }}
                                <div class="form-text">{{ form_help(form.isDefault) }}</div>
                                {{ form_errors(form.isDefault) }}
                            </div>
                        </div>
                    </div>

                    {# Info Bordeaux #}
                    <div class="alert alert-info d-flex align-items-start" role="alert">
                        <i data-feather="info" width="20" class="me-2 mt-1"></i>
                        <div>
                            <strong>Frais de livraison :</strong>
                            <ul class="mb-0 mt-2">
                                <li>Bordeaux : 5€</li>
                                <li>Hors Bordeaux : 5€ + 0,59€/km parcouru</li>
                            </ul>
                        </div>
                    </div>

                    {# Boutons d'action #}
                    <div class="d-flex justify-content-between align-items-center mt-4">
                        <a href="{{ path('app_account_addresses') }}" class="btn btn-outline-secondary">
                            <i data-feather="x" width="18" class="me-2"></i>
                            Annuler
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i data-feather="{% if isEdit %}save{% else %}plus{% endif %}" width="18" class="me-2"></i>
                            {{ isEdit ? 'Enregistrer les modifications' : 'Ajouter l\'adresse' }}
                        </button>
                    </div>

                    {{ form_end(form) }}
                </div>
            </div>

            {# Note sur les champs obligatoires #}
            <div class="mt-3">
                <small class="text-muted">
                    <span class="text-danger">*</span> Champs obligatoires
                </small>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const postalCodeInput = document.querySelector('#address_postalCode');
    const cityInput = document.querySelector('#address_city');
    const cityContainer = cityInput ? cityInput.parentElement : null;

    if (!postalCodeInput || !cityInput || !cityContainer) {
        return; // Les champs n'existent pas sur la page
    }

    let fetchTimeout = null;
    let originalCityValue = cityInput.value; // Sauvegarder la valeur initiale (en cas de modification)
    let citySelectElement = null;

    // Fonction pour transformer l'input en select
    function convertToSelect(cities) {
        // Créer un élément select
        const select = document.createElement('select');
        select.id = 'address_city';
        select.name = 'address[city]';
        select.className = cityInput.className;
        select.required = cityInput.required;

        // Ajouter une option par défaut
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = 'Sélectionnez une ville';
        select.appendChild(defaultOption);

        // Ajouter les villes
        cities.forEach(city => {
            const option = document.createElement('option');
            option.value = city;
            option.textContent = city;

            // Sélectionner automatiquement si c'est la seule ville ou si elle correspond à la valeur actuelle
            if (cities.length === 1 || city === originalCityValue) {
                option.selected = true;
            }

            select.appendChild(option);
        });

        // Remplacer l'input par le select
        cityInput.replaceWith(select);
        citySelectElement = select;

        // Animer pour indiquer le changement
        select.classList.add('border-success');
        setTimeout(() => {
            select.classList.remove('border-success');
        }, 2000);
    }

    // Fonction pour revenir à un input text
    function convertToInput() {
        if (!citySelectElement) return;

        const input = document.createElement('input');
        input.type = 'text';
        input.id = 'address_city';
        input.name = 'address[city]';
        input.className = citySelectElement.className.replace('border-success', '');
        input.required = citySelectElement.required;
        input.placeholder = 'Bordeaux';
        input.value = citySelectElement.value || originalCityValue;

        citySelectElement.replaceWith(input);
        citySelectElement = null;
    }

    // Fonction pour récupérer les villes depuis le code postal
    async function fetchCitiesFromPostalCode(postalCode) {
        // Validation basique : le code postal doit avoir exactement 5 chiffres
        if (!/^[0-9]{5}$/.test(postalCode)) {
            // Si le code postal est incomplet, revenir à un input
            convertToInput();
            return;
        }

        try {
            const response = await fetch(`{{ path('app_address_get_city_from_postal_code', {postalCode: '__POSTAL_CODE__'}) }}`.replace('__POSTAL_CODE__', postalCode));
            const data = await response.json();

            if (data.success && data.cities && data.cities.length > 0) {
                // Transformer en select avec toutes les villes
                convertToSelect(data.cities);
            } else {
                // Pas de ville trouvée, revenir à un input
                convertToInput();
            }
        } catch (error) {
            console.error('Erreur lors de la récupération des villes:', error);
            // En cas d'erreur, revenir à un input
            convertToInput();
        }
    }

    // Écouter les changements du code postal
    postalCodeInput.addEventListener('input', function() {
        const postalCode = this.value.trim();

        // Annuler la requête précédente si elle existe
        if (fetchTimeout) {
            clearTimeout(fetchTimeout);
        }

        // Attendre 500ms après que l'utilisateur a fini de taper
        fetchTimeout = setTimeout(() => {
            fetchCitiesFromPostalCode(postalCode);
        }, 500);
    });

    // Aussi déclencher la recherche lorsque le champ perd le focus
    postalCodeInput.addEventListener('blur', function() {
        const postalCode = this.value.trim();

        if (fetchTimeout) {
            clearTimeout(fetchTimeout);
        }

        fetchCitiesFromPostalCode(postalCode);
    });

    // Si le code postal est déjà rempli au chargement, charger les villes
    if (postalCodeInput.value && postalCodeInput.value.length === 5) {
        fetchCitiesFromPostalCode(postalCodeInput.value);
    }
});
</script>

{% endblock %}